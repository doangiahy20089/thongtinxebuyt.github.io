<!DOCTYPE html> <!--Phần khung cơ bản của html-->
<html lang="vi"> <!--Khai báo trang html sử dụng Tiếng Việt-->

<head>
    <!--Đảm bảo hiển thị trang web trên mọi thiết bị -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--viewport: là vùng hiển thị của trình duyệt trên thiết bị (đth) ,
        width=device-width: chiều rộng trên trang màn hình sử dụng
        initial-scale=1.0: mức zoom ban đầu là 100% định mức giao diện ban đầu-->

    
    <title>Tuyến xe buýt</title> <!--tiêu đề trang web-->
    <!--Dùng để tải thư viện bên ngoài để hiển thị bản đồ (Leaflet), tuyến đường (Leaflet Routing Machine), và MQTT web-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> <!--link nhúng bản đồ-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script> <!--Nhúng web mqtt-->

    <!--Dùng CSS xây dựng giao diện màu, định dạng cho từng mục -->
    <style>
        body {
            font-family: Arial, sans-serif; /*font chữ: Arial hoặc bất kì font ko chân*/
            margin: 0; /*Xóa khoảng cách mặc định (khoảng trắng) xung quanh thân trang.
→ Cho giao diện gọn gàng hơn, không bị lệch.*/
            background-color: #fff; /*Nền trắng (#fff là viết tắt của #ffffff).*/
            color: #000; /*chỉnh màu chữ là màu đen*/
            transition: background-color 0.3s, color 0.3s; /*animation chuyển màu đen thành trắng khi chuyển sang dark mode*/
        }

        .dark-mode {
            background-color: #121212; /*đổi màu background trắng --> đen*/
            color: #fff; /*đổi màu chữ thành trắng*/
        }

        header { /*phần đầu thanh xanh dương trên cùng*/
            background-color: #2196F3; /*mã màu thanh xanh dương trên cùng */
            color: white; /*màu chữ trắng*/
            padding: 1rem; /*tạo khung giữ web*/
            text-align: center; /*chữ ở giữa phần khung xanh dương*/
            position: sticky; /*cuộn trang xuống giữa header và body*/
            top: 0; /*cố định vị trí trang web ở đầu trang*/
            z-index: 10; /*header luôn ở đầu trang và được đè các layer khác lên*/
        }

        #resetPage {
            cursor: pointer; /*hiển thị con trỏ trên thanh header*/
        }

        #darkModeToggle { /*hiển thị darkmode trên web*/
            position: absolute; /*vị trí giá trị tuyệt đối*/
            top: 1rem; /*căn nút cách mép trên và mép phải góc bên phải của trang*/
            right: 1rem;
            padding: 0.3rem 0.6rem; /*tạo khung bên trên để hiển thị vị trí ở giữa*/
            border: none; /*xóa viền thừa*/
            background: white; /*nền của darkmode màu trắng*/
            color: #2196F3; /*mã màu hình mặt trăng */
            border-radius: 4px; /*bo góc */
            cursor: pointer;/*tính năng ấn--> trỏ chuột */
        }

        .bus-list { /*chứa các phần tử của xe buýt*/
            display: flex; /*trình bày các biến xe ngang trên 1 hàng 
                            [Tuyến 08]   [Tuyến 05]   [Tuyến 150] */
            justify-content: center; /*cho các phần tử con ở giữa theo chiều ngang*/
            gap: 1rem; /*tạo khoảng cách giữa các phần con*/
            padding: 1rem; /*tạo khoảng cách khung chứa các phần thử xe con*/
        }

        .bus-card { /*xây dựng giao diện của từng thẻ xe */
            width: 120px; /*chiều rộng của từng thẻ là 120px*/
            padding: 0.5rem; /*tạo khoảng trống ở trong*/
            border: 2px solid #ccc; /*khung viền của thẻ*/
            border-radius: 10px; /*bo góc thẻ*/
            text-align: center; /*khoảng cách thẻ ở giữa*/
            cursor: pointer;/*tính năng trỏ chuột-->click*/
        }

            .bus-card img { /*hiển thị hình ảnh của từng xe*/
                width: 100%; /*giúp thẻ ảnh full ảnh không tràn viền */
                border-radius: 8px; /*bo góc ảnh*/
            }

            .bus-card.selected {
                border-color: #2196F3; /*khi được click vào thì khung viền thay đổi từ xám -->xanh*/
            }

        #map { /*hiển thị giao diện map*/
            height: 400px; /*chiều cao của map*/
            margin: 1rem; /*tạo khoảng trống xung quanh*/
            border-radius: 10px;/*bo góc map*/
        }

        #stop-list {
            margin: 1rem; /*tạo khoảng trống xung quanh*/
            padding: 1rem; /*tạo khung chứa danh sách ở bên dưới*/
            border: 1px solid #ccc; /*tạo viền mỏng cho danh sách trạm*/
            border-radius: 10px; /*bo góc khung ở dưới*/
            background: #f9f9f9; /*màu xám của danh sách*/
        }

        .dark-mode #stop-list {
            background: #1e1e1e;/*đổi màu nền xám --> đen */
            border-color: #555; /*màu viền đổi từ xám nhạt-->xám đen*/
        }
    </style>
</head>

<body>
    <header> <!--phần đầu-->
        <h1 id="resetPage">THÔNG TIN XE BUÝT</h1> <!--hiển thị thanh tiêu đề với kích thước tiêu đề lớn-->
        <button id="darkModeToggle">🌙</button> <!--khởi tạo hiển thị nút ấn darkmode-->
    </header>

    <div class="bus-list"> <!--Tạo thẻ xe 8-->
        <div class="bus-card" data-bus="8">
            <img src="xe8.jpg" alt="Xe buýt tuyến 8" />
            <p>Tuyến 08</p>
        </div>
    <!--danh sách thẻ xe 5-->
    <div class="bus-card" data-bus="5">
            <img src="xe5.jpg" alt="Xe buýt tuyến 5" />
            <p>Tuyến 05</p>
        </div>
    <!--danh sách thẻ xe 150-->
    <div class="bus-card" data-bus="150">
            <img src="xe150.jpg" alt="Xe buýt tuyến 150" />
            <p>Tuyến 150</p>
        </div>
    </div>

    <!--Khởi tạo hiển thị map-->
    <div id="map"></div>

    <!--Hiển thị tên danh sách trạm-->
    <div id="stop-list">
        <h3>Danh sách trạm sẽ đi qua:</h3>
        <ul id="stops"></ul>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script>
        const darkModeBtn = document.getElementById("darkModeToggle");
        darkModeBtn.addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
        });

        document.getElementById("resetPage").addEventListener("click", () => {
            location.reload();
        });

        const busCards = document.querySelectorAll(".bus-card");
        const stopList = document.getElementById("stops");
        let map = L.map('map').setView([10.75, 106.65], 12);

        let routeLayer = null;
        let stopMarkers = [];
        let userMarker = null;
        let xeMarkers = {};
        const busImages = {
            "8": "xe8.jpg",
            "5": "xe5.jpg",
            "150": "xe150.jpg"
        };

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const busRoutes = {
            "8": {
                color: "blue",
                coords: [
                    [10.740, 106.665, "Bến xe buýt Quận 8"],
                    [10.743, 106.667, "Đường Tạ Quang Bửu"],
                    [10.750, 106.660, "Quốc lộ 50"],
                    [10.755, 106.655, "Cầu Nhị Thiên Đường"],
                    [10.760, 106.660, "Đường Tùng Thiện Vương"],
                    [10.765, 106.662, "Cầu Chà Và"],
                    [10.768, 106.663, "Đường Hải Thượng Lãn Ông"],
                    [10.770, 106.664, "Đường Triệu Quang Phục"],
                    [10.772, 106.665, "Đường Châu Văn Liêm"],
                    [10.775, 106.667, "Đường Hồng Bàng"],
                    [10.780, 106.670, "Đường Lý Thường Kiệt"],
                    [10.785, 106.672, "Đường Hoàng Văn Thụ"],
                    [10.790, 106.675, "Đường Phan Đăng Lưu"],
                    [10.795, 106.678, "Đường Bạch Đằng"],
                    [10.800, 106.680, "Đường Xô Viết Nghệ Tĩnh"],
                    [10.805, 106.683, "Quốc lộ 13"],
                    [10.810, 106.685, "Đường Phạm Văn Đồng"],
                    [10.815, 106.688, "Đường Kha Vạn Cân"],
                    [10.820, 106.690, "Đường Võ Văn Ngân"],
                    [10.825, 106.693, "Ngã tư Thủ Đức"],
                    [10.830, 106.695, "Xa lộ Hà Nội"],
                    [10.835, 106.698, "Quốc lộ 1"],
                    [10.840, 106.700, "Cầu vượt quay đầu"],
                    [10.850, 106.703, "Đường 621"],
                    [10.860, 106.705, "Quảng trường Sáng Tạo"],
                    [10.865, 106.707, "Đường Vành Đai"],
                    [10.868, 106.709, "Đường Nguyễn Hiền"],
                    [10.870, 106.800, "Bến xe buýt Khu A ĐHQG TP.HCM"]
                ]
            },
            /* "9": {
                color: "green",
                coords: [
                    [10.755, 106.635, "Bến xe buýt Chợ Lớn (Bến A)"],
                    [10.758, 106.637, "Đường Lê Quang Sung"],
                    [10.760, 106.638, "Đường Phạm Đình Hổ"],
                    [10.765, 106.640, "Đường Hồng Bàng"],
                    [10.770, 106.645, "Đường Kinh Dương Vương"],
                    [10.775, 106.648, "Quốc lộ 1"],
                    [10.780, 106.650, "Đường Đinh Đức Thiện"],
                    [10.785, 106.653, "Hương lộ 11"],
                    [10.790, 106.655, "Hưng Long"]
                ]
            }, */
            "5": {
                color: "green",
                coords: [
                    [10.915, 106.795, "Cầu Ông Dầu"],
                    [10.920, 106.800, "Đường số 3"],
                    [10.925, 106.805, "Đường số 4"],
                    [10.930, 106.810, "Cân Nhơn Hòa"],
                    [10.935, 106.815, "Ngã 3 Hiệp Bình"],
                    [10.940, 106.820, "Ngã 3 Đường Hiệp Bình"],
                    [10.945, 106.825, "Trạm y tế Hiệp Bình Phước"],
                    [10.950, 106.830, "UBND P.Hiệp Bình Phước"],
                    [10.955, 106.835, "Hồ Bơi"],
                    [10.960, 106.840, "Ngã 4 Bình Phước"],
                    [10.965, 106.845, "Chợ Đầu Mối"],
                    [10.970, 106.850, "Chợ Tam Bình"],
                    [10.975, 106.855, "Hồ Bơi"],
                    [10.980, 106.860, "Chợ Tam Hải"],
                    [10.985, 106.865, "Cầu vượt Sóng Thần"],
                    [10.990, 106.870, "Bến xe Lam Hồng"],
                    [10.995, 106.875, "Giày da Thái Bình"],
                    [11.000, 106.880, "Linh Xuân"],
                    [11.005, 106.885, "Cầu vượt Linh Xuân"],
                    [11.010, 106.890, "Chợ Linh Xuân"],
                    [11.015, 106.895, "Thánh thất Cao Đài Linh Xuân"],
                    [11.020, 106.900, "Đường số 8"],
                    [11.025, 106.905, "Chùa Từ Quang"],
                    [11.030, 106.910, "Big C"]
                ]
            },
            "150": {
                color: "red",
                coords: [
                    /*[10.740, 106.620, "Bến xe Miền Tây"],
                    [10.745, 106.625, "Đường Kinh Dương Vương"],
                    [10.750, 106.630, "Đường Hậu Giang"],
                    [10.755, 106.635, "Đường Tháp Mười"],
                    [10.760, 106.640, "Đường Hải Thượng Lãn Ông"],
                    [10.765, 106.645, "Đường Châu Văn Liêm"],
                    [10.770, 106.650, "Đường Hồng Bàng"],
                    [10.775, 106.655, "Đường An Dương Vương"],
                    [10.780, 106.660, "Đường Nguyễn Tri Phương"],
                    [10.785, 106.665, "Đường 3 Tháng 2"],
                    [10.790, 106.670, "Đường Lý Thái Tổ"],
                    [10.795, 106.675, "Đường Điện Biên Phủ"],
                    [10.800, 106.680, "Đường Võ Nguyên Giáp"],
                    [10.805, 106.685, "Xa lộ Hà Nội"],
                    [10.810, 106.690, "Quốc lộ 1"],
                    [10.815, 106.695, "Cầu vượt quay đầu"],
                    [10.820, 106.700, "Đường song hành bờ Nam Quốc lộ 1"],
                    [10.825, 106.705, "Đường 621"],
                    [10.830, 106.710, "Quảng Trường Sáng Tạo"],
                    [10.835, 106.715, "Đường Vành Đai"],
                    [10.840, 106.720, "Đường Nguyên Hiền"],
                    [10.845, 106.725, "Bến xe buýt khu A Đại học Quốc gia TP.HCM"] */
                    [10.746, 106.634, "Bến xe Chợ Lớn"],
                    [10.776, 106.693, "Chu Văn An"],
                    [10.775, 106.634, "Thuận Kiều Plaza"],
                    [10.757, 106.634, "Bệnh viện Chợ Rẫy"],
                    [10.762, 106.634, "Cầu Điện Biên Phủ"],
                    [10.762, 106.634, "Trạm Điện Nguyễn Cửu Vân"],
                    [10.762, 106.634, "Đại học Hồng Bàng"],
                    [10.762, 106.634, "Vòng xoay Hàng Xanh"],
                    [10.762, 106.634, "Đại học Hutech"],
                    [10.762, 106.634, "Khu Du lịch Văn Thánh"],
                    [10.762, 106.634, "Cầu Sài Gòn"],
                    [10.762, 106.634, "Cầu Đen"],
                    [10.762, 106.634, "Thảo Điền"],
                    [10.762, 106.634, "Metro Quận 2"],
                    [10.762, 106.634, "Cát Lái"],
                    [10.762, 106.634, "Xi măng hà tiên - trạm thu phí"],
                    [10.762, 106.634, "Ngã 4 Tây Hòa (RMK)"],
                    [10.762, 106.634, "Trạm xây dựng"],
                    [10.762, 106.634, "Khu QLGTDT số 2"],
                    [10.762, 106.634, "Ngã 4 Bình Thái"],
                    [10.762, 106.634, "UBND quận 9"],
                    [10.762, 106.634, "Bê tông Hải Âu"],
                    [10.762, 106.634, "Ngã 4 Thủ Đức"],
                    [10.762, 106.634, "Công an Quận 9"],
                    [10.762, 106.634, "Chợ chiều"],
                    [10.762, 106.634, "Khu Công nghệ cao quận 9"],
                    [10.762, 106.634, "Cầu Vượt Trạm 2"],
                    [10.762, 106.634, "Suối Tiên"],
                    [10.762, 106.634, "Nghĩa trang liệt sĩ TP.HCM"],
                    [10.762, 106.634, "Công ty Nam Hàn"],
                    [10.762, 106.634, "Khu tưởng niệm các Vua Hùng"],
                    [10.762, 106.634, "Trạm xăng Hiệp Phú"],
                    [10.762, 106.634, "Ngã 3 Tân Vạn"],
                    [10.762, 106.634, "Tân Vạn"]
                ]
            }
        };

        /*function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Bán kính trái đất (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Khoảng cách (km)
        } */

        busCards.forEach(card => {
            card.addEventListener("click", () => { /*xử lí việc nhấn vào trạm*/
                busCards.forEach(c => c.classList.remove("selected"));
                card.classList.add("selected");

                const busNumber = card.dataset.bus; /*dữ liệu số xe sẽ cập nhật dữ liệu xe buýt đó*/
                const route = busRoutes[busNumber]; /*vẽ đường giữa các trạm*/

                /* clear road map cũ */
                if (routeLayer) routeLayer.remove();
                stopMarkers.forEach(marker => marker.remove()); /*xóa các điểm trên trạm cũ*/
                stopMarkers = []; /*trống danh sách trạm hiển thị */
                stopList.innerHTML = ""; /*xóa các trạm trên giao diện*/


                routeLayer = L.Routing.control({
                    waypoints: route.coords.map(c => L.latLng(c[0], c[1])),
                    lineOptions: { styles: [{ color: route.color, weight: 5 }] },
                    createMarker: () => null,
                    addWaypoints: false,
                    draggableWaypoints: false,
                    routeWhileDragging: false,
                    show: false
                }).addTo(map);

                route.coords.forEach(([lat, lng, name], index) => {
                    const marker = L.marker([lat, lng]).addTo(map).bindPopup(name);
                    stopMarkers.push(marker);
                    const li = document.createElement("li");
                    li.textContent = `${index + 1}. ${name}`;
                    stopList.appendChild(li);
                });

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const latlng = [position.coords.latitude, position.coords.longitude];
                        if (userMarker) userMarker.remove();
                        userMarker = L.marker(latlng).addTo(map).bindPopup("Vị trí của bạn").openPopup();
                    });
                }
            });
        });

        const mqttClient = new Paho.MQTT.Client("wss://214f09799e8e4edc953995b375c60fa3.s1.eu.hivemq.cloud:8884/mqtt", "client-hhhh" + Math.random());
        mqttClient.connect({
            useSSL: true,
            userName: "project",
            password: "345678910JQKA2toitrang",
            onSuccess: () => {
                console.log("MQTT connected");
               /* mqttClient.subscribe("8");
                mqttClient.subscribe("9");
                mqttClient.subscribe("10"); */
                mqttClient.subscribe("tram/#");
            },
            onFailure: err => console.error("Lỗi kết nối MQTT", err)
        });

        mqttClient.onMessageArrived = msg => {
            const topic = msg.destinationName;
            const payload = msg.payloadString.trim().toLowerCase();

            console.log("MQTT message:", payload);
            //Xác nhận đây là topic dạng trạm/x
            /* const tramMatch = topic.match(/^tram(\d+)$/);  // khớp với tram2, tram15,...
            if (!tramMatch) return;
            const tramIndex = parseInt(tramMatch[1]); // "tram5" → 5 */
            if (!topic.startsWith("tram/")) return;
            const tramIndex = parseInt(topic.split("/")[1])-1; // "tram/5" → 5
            const [lat, lng, stopName] = route.coords[tramIndex];
            busRoutes["8"].coords.length === 28 // có 28 trạm từ 0 đến 27
            busRoutes["5"].coords.length === 24
            busRoutes["150"].coords.length === 34
            if (isNaN(tramIndex)) return;
          
            //Kiểm tra nếu payload chứa thông tin xe đã đến
            if (!payload.includes("da den")) return;

            //Xe... đã đến --> tách số xe 
            const xeMatch = payload.match(/xe\s*(\d+)/);
            if (!xeMatch) return;
            const xeNumber = xeMatch[1]; // "9"

            //Tìm tuyến đường ứng với số xe đó 
            const route = busRoutes[xeNumber];
            if (!route || tramIndex >= route.coords.length) return;

            //Lấy tọa độ trạm từ dữ liệu tuyến xe
            const [lat, lng, stopName] = route.coords[tramIndex];

            //Tạo marker riêng biệt cho từng xe tại từng trạm
          //  updateBusMarker(`${xeNumber}-at-tram-${tramIndex}`, [lat, lng], `Xe ${xeNumber} vừa tới trạm: ${stopName}`);
            updateBusMarker(`Xe ${xeNumber} vừa tới trạm: ${stopName}`, xeNumber, [lat, lng]);
            //console.log(`Xe ${xeNumber} đang ở tramIndex ${tramIndex}: ${stopName}`);
            //tramIndex chức năng là truyền các trạm và các tuyến đường tương ứng
            //bỏ tramIndex để cập nhật liên tục vị trí xe đó
            //if(topic==)
            //topic trạm 5

            //msg xe ... đã đến (nếu mes chứa "da den")
            // thì --> dung 1 bien de luu topic, bien do se la tram
            // tu tram do, trich vao toa do rieng cua tram

            // trích cái xe ra từ msg
           /* hiện ra xe nào đang ở trạm

            --> điểm khác biệt là:
            ban đầu: topic là xe, msg là tọa độ trạm luôn
            bây g: topic là tên trạm thoi, tự trích xuất và lưu tọa độ riêng của trạm sau; msg sẽ là xe
            */


           /* đã đến trạm tách số xe trong trạm 
            Làm hiển thị nhiều xe cùng lúc cùng 1 trạm
            */



            // Nếu là tọa độ dạng lat,lng
            /*
            if (payload.includes(",")) {
                const [latStr, lngStr] = payload.split(',');
                const lat = parseFloat(latStr);
                const lng = parseFloat(lngStr);
                if (isNaN(lat) || isNaN(lng)) return;

                // Cập nhật vị trí xe buýt theo tọa độ
                updateBusMarker(topic, [lat, lng]);
            }

            // Nếu là tin dạng "xe 8 da den" hoặc "xe 8 cach 2"
            // Xử lý tin nhắn kiểu: topic = tram/2, payload = "xe da toi tram"
            else if (topic.startsWith("tram/") && payload === "xe da toi tram") {
                const tramIndex = parseInt(topic.split("/")[1]); // Lấy số trạm từ topic: tram/2 => 2
                if (isNaN(tramIndex)) return;

                // Tìm xe đang được chọn (busCard đang có class 'selected')
                const selectedCard = document.querySelector(".bus-card.selected");
                if (!selectedCard) return;
                const busNumber = selectedCard.dataset.bus;
                const route = busRoutes[busNumber];
                if (!route) return;
                */

           /* else if (topic.startsWith("tram/") && payload.includes("da den")) {
                const tramIndex = parseInt(topic.split("/")[1]);
                if (isNaN(tramIndex)) return;

                // 🚌 Trích số xe từ chuỗi msg, ví dụ: "xe 8 da den"
                const xeMatch = payload.match(/xe\s*(\d+)/);
                if (!xeMatch) return;
                const xeNumber = xeMatch[1]; // Ví dụ: "8"

                // 🔍 Tìm tuyến xe đang được chọn
                const route = busRoutes[xeNumber];
                if (!route || tramIndex >= route.coords.length) return;

                const [lat, lng, stopName] = route.coords[tramIndex];

                // 🆕 Cập nhật xe này đến vị trí trạm
                updateBusMarker(`${xeNumber}-at-tram-${tramIndex}`, [lat, lng], `Xe ${xeNumber} vừa tới trạm: ${stopName}`);
            }
             */ 


                /* if (tramIndex >= 0 && tramIndex < route.coords.length) {
                    const [lat, lng, stopName] = route.coords[tramIndex];
                    updateBusMarker(busNumber, [lat, lng], `Xe vừa tới trạm: ${stopName}`);
                } */
            

        };

        // Hàm cập nhật vị trí xe buýt lên bản đồ
         /*function updateBusMarker(busNumber, latlng, popupText = "") {
            const icon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/190/190411.png',
                iconSize: [30, 30]
            });

            if (xeMarkers[busNumber]) {
                xeMarkers[busNumber].setLatLng(latlng);
                if (popupText) xeMarkers[busNumber].bindPopup(popupText);
            } else {
                xeMarkers[busNumber] = L.marker(latlng, { icon }).addTo(map);
                console.log("Tạo marker xe:", busNumber, latlng, popupText);
               // const html = `<b>🚍 Xe tuyến ${busNumber}</b><br>${popupText}<br><img src="${busImages[busNumber]}" style="width:100px"/>`;
               // xeMarkers[busNumber].bindPopup(html); 
                //xeMarkers[id] = L.marker(latlng, { icon }).addTo(map);
                xeMarkers[busNumber].bindPopup(popupText || "Vị trí xe buýt");
            }

            map.setView(latlng, 14);
        } */
        function updateBusMarker(busNumber, latlng, popupText = "") {
            const icon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/190/190411.png',
                iconSize: [30, 30]
            });

            // Nếu marker đã tồn tại → cập nhật lại vị trí và popup
            if (xeMarkers[busNumber]) {
                xeMarkers[busNumber].setLatLng(latlng);
                if (popupText) xeMarkers[busNumber].bindPopup(popupText);
            } else {
                // Nếu chưa có → tạo mới
                xeMarkers[busNumber] = L.marker(latlng, { icon }).addTo(map);
                xeMarkers[busNumber].bindPopup(popupText || "Vị trí xe buýt");
            }

            map.setView(latlng, 14);
        }


    </script>
</body>
</html>
